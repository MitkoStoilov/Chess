<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/chessboard-0.3.0.min.css">
<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="/js/chessboard-0.3.0.min.js"></script>
<script src="/js/chess.js"></script>
<script src="/socket.io/socket.io.js"></script>
<div id = "container">
  <p id="user"><%= user%></p>
  <p><b>white:</b> <span id="white"><%= white%></span></p>
  <p><b>black:</b> <span id="black"><%= black%></span></p>
  <p>room number: <b><span id="roomno"></span></b></p>
  <a href="/logout">Logout</a><br/>

  <div id="board" style="width: 400px; margin-top: 30px"></div>

  <div id="game_data">
    <p>Status: <span id="status"></span></p>
    <p>FEN: <span id="fen"></span></p>
    <p>PGN: <span id="pgn"></span></p>
    <input type="button" id="flipOrientationBtn" value="Flip orientation" />
  </div>
</div>

<script type="text/javascript">
  var parameter = window.location.search.replace( "?", "" );
  var values = parameter.split("=");
  var roomno = values[1];
  document.getElementById('roomno').innerHTML = values[1];

  var usr = document.getElementById('user').innerHTML;

  $(function(){
      var socket = io.connect();

      socket.emit('connectToRoom', roomno);

      var fen;

      var board,
        game = new Chess(),
        statusEl = $('#status'),
        fenEl = $('#fen'),
        pgnEl = $('#pgn'),
        user = $('#user'),
        white = $('#white'),
        black = $('#black');

      var onDragStart = function(source, piece, position, orientation) {
        if (game.game_over() === true ||
            (user.text() === white.text() && piece.search(/^b/) !== -1) ||
            (user.text() === black.text() && piece.search(/^w/) !== -1)){

          return false;
        }else{
          return false;
        }

      };


      var onDrop = function(source, target) {

        var move = game.move({
          from: source,
          to: target,
          promotion: 'q'
        });

        if (move === null) return 'snapback';

        socket.emit('make a move', {fen: game.fen(), num: roomno});

        updateStatus();

      };


      var onSnapEnd = function() {
        board.position(game.fen());
      };




      socket.on('new move', function(data){
        board.position(data);
        game.load(data);
        updateStatus();
      });


      var updateStatus = function() {
        var status = '';

        var moveColor = 'White';
        if (game.turn() === 'b') {
          moveColor = 'Black';
        }

        if (game.in_checkmate() === true) {
          status = 'Game over, ' + moveColor + ' is in checkmate.';
        }

        else if(game.in_threefold_repetition()){
          status = 'Game draw due to threefolded repetition';
        }

        else if(game.insufficient_material()){
          status = 'Game over due to insufficient material';
        }

        else if (game.in_draw() === true) {
          status = 'Game over, drawn position';
        }

        else {
          status = moveColor + ' to move';
          if (game.in_check() === true) {
            status += ', ' + moveColor + ' is in check';
          }
      }

        statusEl.html(status);
        fenEl.html(game.fen());
        pgnEl.html(game.pgn());
      };


      var cfg = {
        draggable: true,
        orientation: 'white',
        position: 'start',
        onDragStart: onDragStart,
        onDrop: onDrop,
        onSnapEnd: onSnapEnd
      };


      board = ChessBoard('board', cfg);

      socket.on('load', function(data) {
        board.position(data.fen);
        game.load(data.fen);
        if(data.player1 !== user.text()){
          board.flip();
        }
        updateStatus();
      });




      $('#flipOrientationBtn').on('click', function(){
        board.flip();
      });

      updateStatus();
    });

</script>
